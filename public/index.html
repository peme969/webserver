<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Python Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #1e1e1e;
        }
        #terminal {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="terminal"></div>
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links/lib/xterm-addon-web-links.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-unicode11/lib/xterm-addon-unicode11.js"></script>
    <script>
        // Create an instance of the xterm.js terminal with additional add-ons
        const term = new Terminal({
            screenKeys: true,
            useStyle: true,
            cursorBlink: true,
        });

        // Add support for clickable links
        term.loadAddon(new WebLinksAddon.WebLinksAddon());

        // Add Unicode 11 support
        const unicodeAddon = new Unicode11Addon.Unicode11Addon();
        term.loadAddon(unicodeAddon);
        term.unicode.activeVersion = '11';

        // Terminal settings
        term.setOption("fontFamily", "monospace");
        term.setOption('scrollback', 9999999);

        // Add fit functionality
        const fit = new FitAddon.FitAddon();
        term.loadAddon(fit);

        // Open terminal in the #terminal div
        term.open(document.getElementById("terminal"));
        fit.fit();

        // Set up WebSocket connection
        const proto = location.protocol === "http:" ? "ws://" : "wss://";
        const query = new URL(location.href).searchParams;
        query.append("mode", "script"); // Add mode=script to the query parameters

        const websocket = new WebSocket(
            proto + location.hostname + (location.port ? ":" + location.port : "") + "/term?" + query.toString()
        );
        websocket.binaryType = "arraybuffer";

        websocket.onopen = function (event) {
            // Handle user input and send it to the WebSocket
            term.onData((data) => websocket.send(new TextEncoder().encode("\x00" + data)));

            // Handle terminal resize and notify the WebSocket
            term.onResize((data) =>
                websocket.send(new TextEncoder().encode("\x01" + JSON.stringify(data)))
            );

            // Update document title when terminal title changes
            term.onTitleChange((title) => (document.title = title));

            // Display WebSocket messages in the terminal
            websocket.onmessage = ({ data }) => term.write(new Uint8Array(data));
        };

        websocket.onclose = (event) => {
            // Notify user and destroy terminal on WebSocket close
            term.write("\r\nSession terminated\r\n");
            term.destroy();
        };

        // Automatically resize terminal when window resizes
        function reportWindowSize() {
            fit.fit();
        }
        window.onresize = reportWindowSize;
    </script>
</body>
</html>
