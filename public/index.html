<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Python Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #1e1e1e;
        }
        #terminal {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="terminal"></div>
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links/lib/xterm-addon-web-links.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-unicode11/lib/xterm-addon-unicode11.js"></script>
    <script>
        // Initialize the terminal with the allowProposedApi option enabled
        const term = new Terminal({
            screenKeys: true,
            useStyle: true,
            cursorBlink: true,
            allowProposedApi: true, // Enable proposed API usage
        });

        // Add the Unicode 11 addon
        const unicodeAddon = new Unicode11Addon.Unicode11Addon();
        term.loadAddon(unicodeAddon);
        term.unicode.activeVersion = '11';

        // Add clickable links support
        term.loadAddon(new WebLinksAddon.WebLinksAddon());

        // Add the FitAddon for resizing the terminal
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        // Open the terminal in the #terminal div
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        // Set up WebSocket communication
        const proto = location.protocol === 'http:' ? 'ws://' : 'wss://';
        const websocket = new WebSocket(proto + location.host + '/term');

        websocket.binaryType = 'arraybuffer';

        websocket.onopen = () => {
            // Handle user input and send to WebSocket
            term.onData((data) =>
                websocket.send(new TextEncoder().encode("\x00" + data))
            );

            // Handle terminal resize events
            term.onResize((size) => {
                websocket.send(
                    new TextEncoder().encode("\x01" + JSON.stringify(size))
                );
            });

            // Display WebSocket messages in the terminal
            websocket.onmessage = ({ data }) => {
                term.write(new Uint8Array(data));
            };
        };

        websocket.onclose = () => {
            term.write('\r\nSession terminated\r\n');
            term.destroy();
        };

        // Automatically fit terminal to window size
        window.addEventListener('resize', () => fitAddon.fit());
    </script>
</body>
</html>
